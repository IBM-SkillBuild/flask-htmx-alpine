<div class="chat-widget" id="chat-widget-container">
  <div class="chat-header">
    <div class="d-flex align-items-center">
      <div class="chat-avatar me-2">ü§ñ</div>
      <div>
        <h6 class="mb-0">Asistente Virtual</h6>
        <small class="text-success">En l√≠nea</small>
      </div>
      <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="closeChat()">
        ‚ùå
      </button>
    </div>
  </div>

  <div class="chat-messages" id="chat-messages">
    <div class="message bot-message">
      <div class="message-avatar">ü§ñ</div>
      <div class="message-content">
        <div class="message-bubble">
          ¬°Hola! üëã Soy tu asistente virtual. ¬øEn qu√© puedo ayudarte hoy?
        </div>
        <small class="message-time">Ahora</small>
      </div>
    </div>
  </div>

  <div class="chat-input">
    <div class="input-group">
      <input 
        type="text" 
        class="form-control" 
        id="chat-input" 
        placeholder="Escribe tu mensaje..."
        onkeypress="handleChatKeyPress(event)"
      >
      <button class="btn btn-primary" onclick="sendMessage()">
        üì§
      </button>
    </div>
  </div>

  <div class="typing-indicator" id="typing-indicator" style="display: none;">
    <div class="message bot-message">
      <div class="message-avatar">ü§ñ</div>
      <div class="message-content">
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.chat-widget {
  border: 2px solid var(--border-color);
  border-radius: 12px;
  background: var(--card-bg);
  max-width: 400px;
  height: 500px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  animation: chatSlideIn 0.3s ease-out;
}

@keyframes chatSlideIn {
  from {
    opacity: 0;
    transform: translateY(20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.chat-header {
  background: linear-gradient(135deg, #0d6efd, #0056b3);
  color: white;
  padding: 1rem;
  border-radius: 10px 10px 0 0;
}

.chat-avatar {
  width: 35px;
  height: 35px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2em;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  background: var(--bg-color);
}

.message {
  display: flex;
  margin-bottom: 1rem;
  animation: messageSlideIn 0.3s ease-out;
}

@keyframes messageSlideIn {
  from {
    opacity: 0;
    transform: translateX(-10px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.user-message {
  flex-direction: row-reverse;
}

.user-message .message-content {
  align-items: flex-end;
}

.user-message .message-bubble {
  background: #0d6efd;
  color: white;
}

.message-avatar {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1em;
  margin: 0 0.5rem;
  background: var(--card-bg);
  border: 2px solid var(--border-color);
}

.user-message .message-avatar {
  background: #0d6efd;
  color: white;
  border-color: #0d6efd;
}

.message-content {
  display: flex;
  flex-direction: column;
  max-width: 70%;
}

.message-bubble {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 18px;
  padding: 0.75rem 1rem;
  color: var(--text-color);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.message-time {
  color: var(--footer-text);
  margin-top: 0.25rem;
  font-size: 0.75em;
}

.chat-input {
  padding: 1rem;
  background: var(--card-bg);
  border-top: 1px solid var(--border-color);
  border-radius: 0 0 10px 10px;
}

.typing-indicator .typing-dots {
  display: flex;
  align-items: center;
  padding: 0.75rem 1rem;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 18px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.typing-dots span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--text-color);
  margin: 0 2px;
  animation: typingDot 1.4s infinite ease-in-out;
  opacity: 0.4;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typingDot {
  0%, 80%, 100% {
    transform: scale(0.8);
    opacity: 0.4;
  }
  40% {
    transform: scale(1);
    opacity: 1;
  }
}

/* Responsive */
@media (max-width: 768px) {
  .chat-widget {
    max-width: 100%;
    height: 400px;
  }
}
</style>

<script>
// Chat bot con IA simulada
const chatBot = {
  responses: {
    // Saludos
    'hola': ['¬°Hola! üëã ¬øC√≥mo puedo ayudarte hoy?', '¬°Hola! Me alegra verte por aqu√≠. ¬øEn qu√© puedo asistirte?'],
    'buenos dias': ['¬°Buenos d√≠as! ‚òÄÔ∏è ¬øC√≥mo puedo ayudarte?', '¬°Buenos d√≠as! Espero que tengas un excelente d√≠a. ¬øEn qu√© puedo asistirte?'],
    'buenas tardes': ['¬°Buenas tardes! üåÖ ¬øEn qu√© puedo ayudarte?', '¬°Buenas tardes! ¬øC√≥mo va tu d√≠a?'],
    'buenas noches': ['¬°Buenas noches! üåô ¬øEn qu√© puedo asistirte?', '¬°Buenas noches! ¬øC√≥mo puedo ayudarte?'],
    
    // Informaci√≥n general
    'que es esto': ['Esta es una aplicaci√≥n SPA (Single Page Application) construida con Flask, HTMX y Alpine.js. ¬°Es una demo interactiva!', 'Es una aplicaci√≥n web moderna que demuestra tecnolog√≠as como Flask, HTMX y Alpine.js trabajando juntas.'],
    'como funciona': ['La aplicaci√≥n usa HTMX para navegaci√≥n sin recargas y Alpine.js para reactividad. ¬°Todo funciona de forma fluida!', 'Combina el poder del backend Flask con la interactividad del frontend moderno.'],
    'tecnologias': ['Usamos Flask (Python), HTMX, Alpine.js, Bootstrap y mucho amor por el c√≥digo limpio! üíª', 'La stack incluye: Flask, HTMX, Alpine.js, Bootstrap CSS y JavaScript vanilla.'],
    
    // Soporte
    'ayuda': ['¬°Por supuesto! Puedo ayudarte con informaci√≥n sobre la aplicaci√≥n, sus funciones o cualquier duda t√©cnica.', 'Estoy aqu√≠ para ayudarte. ¬øTienes alguna pregunta espec√≠fica?'],
    'problema': ['Lamento escuchar que tienes un problema. ¬øPodr√≠as contarme m√°s detalles para poder ayudarte mejor?', '¬øQu√© tipo de problema est√°s experimentando? Intentar√© ayudarte a resolverlo.'],
    'error': ['Los errores pueden ser frustrantes. ¬øPodr√≠as describir qu√© error est√°s viendo?', 'Entiendo tu frustraci√≥n. ¬øQu√© mensaje de error aparece?'],
    
    // Funcionalidades
    'contacto': ['Puedes usar el formulario de contacto en esta misma p√°gina para enviar un mensaje. ¬°Se env√≠a por email!', 'El formulario de contacto est√° justo arriba. Solo completa los campos y env√≠a tu mensaje.'],
    'tema': ['¬°Puedes cambiar entre tema claro y oscuro usando el bot√≥n flotante en la esquina superior derecha! üåô‚òÄÔ∏è', 'El bot√≥n de tema est√° en la esquina superior derecha. ¬°Prueba cambiar entre claro y oscuro!'],
    'navegacion': ['Puedes navegar usando el men√∫ superior: Home, Inicio, Acerca de y Contacto. ¬°Todo funciona sin recargar la p√°gina!', 'La navegaci√≥n es s√∫per fluida gracias a HTMX. Prueba los enlaces del men√∫ superior.'],
    
    // Despedidas
    'gracias': ['¬°De nada! üòä ¬øHay algo m√°s en lo que pueda ayudarte?', '¬°Un placer ayudarte! ¬øNecesitas algo m√°s?'],
    'adios': ['¬°Hasta luego! üëã Que tengas un excelente d√≠a.', '¬°Nos vemos! Gracias por probar la aplicaci√≥n. üòä'],
    'chao': ['¬°Chao! üëã ¬°Vuelve cuando quieras!', '¬°Hasta pronto! Que tengas un buen d√≠a. üòä'],
    
    // Default
    'default': [
      'Interesante pregunta. ¬øPodr√≠as ser m√°s espec√≠fico?',
      'No estoy seguro de entender completamente. ¬øPodr√≠as reformular tu pregunta?',
      'Hmm, esa es una buena pregunta. ¬øHay algo espec√≠fico sobre la aplicaci√≥n que te gustar√≠a saber?',
      'Me gustar√≠a ayudarte mejor. ¬øPodr√≠as darme m√°s contexto?',
      'Esa es una consulta interesante. ¬øTe refieres a alguna funcionalidad espec√≠fica de la app?'
    ]
  },

  getResponse(message) {
    const msg = message.toLowerCase().trim();
    
    // Buscar coincidencias exactas primero
    for (const [key, responses] of Object.entries(this.responses)) {
      if (key !== 'default' && msg.includes(key)) {
        return responses[Math.floor(Math.random() * responses.length)];
      }
    }
    
    // Si no hay coincidencias, usar respuesta por defecto
    const defaultResponses = this.responses.default;
    return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
  }
};

// Funciones del chat
function sendMessage() {
  const input = document.getElementById('chat-input');
  const message = input.value.trim();
  
  if (!message) return;
  
  // Agregar mensaje del usuario
  addMessage(message, 'user');
  input.value = '';
  
  // Mostrar indicador de escritura
  showTypingIndicator();
  
  // Simular delay de respuesta (1-3 segundos)
  const delay = Math.random() * 2000 + 1000;
  setTimeout(() => {
    hideTypingIndicator();
    const response = chatBot.getResponse(message);
    addMessage(response, 'bot');
  }, delay);
}

function addMessage(text, sender) {
  const messagesContainer = document.getElementById('chat-messages');
  const messageDiv = document.createElement('div');
  const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  
  messageDiv.className = `message ${sender}-message`;
  messageDiv.innerHTML = `
    <div class="message-avatar">${sender === 'user' ? 'üë§' : 'ü§ñ'}</div>
    <div class="message-content">
      <div class="message-bubble">${text}</div>
      <small class="message-time">${currentTime}</small>
    </div>
  `;
  
  messagesContainer.appendChild(messageDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
  document.getElementById('typing-indicator').style.display = 'block';
  const messagesContainer = document.getElementById('chat-messages');
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
  document.getElementById('typing-indicator').style.display = 'none';
}

function handleChatKeyPress(event) {
  if (event.key === 'Enter') {
    sendMessage();
  }
}

function closeChat() {
  const chatWidget = document.getElementById('chat-widget');
  if (chatWidget) {
    chatWidget.innerHTML = '';
  }
  
  // Scroll suave hacia arriba con FluidScroll
  if (typeof fluidScroll !== "undefined") {
    fluidScroll({
      yPos: "start",
      easing: "easeOutQuart",
      duration: 1500
    });
    console.log('üîù Scroll to top ejecutado despu√©s de cerrar chat');
  }
  
  console.log('üí¨ Chat cerrado');
}

// Inicializar chat
document.addEventListener('htmx:afterSettle', function(event) {
  if (event.target.querySelector('#chat-widget-container')) {
    console.log('üí¨ Chat bot inicializado');
    
    // Focus en el input despu√©s de un momento
    setTimeout(() => {
      const chatInput = document.getElementById('chat-input');
      if (chatInput) {
        chatInput.focus();
      }
    }, 500);
  }
});
</script>